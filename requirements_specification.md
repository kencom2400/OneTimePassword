# ワンタイムパスワード生成アプリケーション 要件定義書

## 1. プロジェクト概要

### 1.1 目的
Google Authenticatorと同様の機能を持つワンタイムパスワード（OTP）生成アプリケーションの開発

### 1.2 背景
- Google Authenticatorで表示される6桁数字を生成する
- 複数のアカウントのOTPを同時に管理・表示する
- QRコードからセキュリティコードを抽出し、ローカルでOTPを生成する
- PCのカメラを使用してQRコードを直接読み取る

## 2. 機能要件

### 2.1 QRコード読み込み機能
- **入力**: PCカメラによるQRコード読み取り
- **処理**: QRコードを解析し、URL形式を検証
- **出力**: セキュリティコードの抽出とローカル保存

#### 2.1.1 QRコード形式検証
- 有効な形式: `otpauth-migration://offline?data=[英数特殊記号文字列]`
- 無効な形式の場合: エラーメッセージを表示

#### 2.1.2 セキュリティコード抽出プロセス
1. Dockerコンテナ（otpauth）を使用してQRコードURLを解析
2. 出力形式: `otpauth://totp/[Device名]@[アカウント名]?algorithm=SHA1&digits=6&issuer=[IssueName]&period=30&secret=[SecurityCode]`
3. `secret`パラメータの値をセキュリティコードとして抽出

#### 2.1.3 PCカメラ連動機能
- **カメラアクセス**: PCの内蔵カメラまたはUSBカメラを使用
- **リアルタイム読み取り**: カメラ映像からリアルタイムでQRコードを検出
- **自動認識**: QRコードが検出されたら自動的に読み取り処理を実行
- **手動トリガー**: ユーザーが手動で読み取りを開始することも可能

### 2.2 セキュリティコード管理機能
- **保存**: ローカルファイル（JSON形式推奨）
- **暗号化**: セキュリティコードは暗号化して保存
- **複数管理**: 複数のアカウントのセキュリティコードを同時に管理
- **GitHub除外**: 保存ファイルはGitHubにコミットしない

#### 2.2.1 データ構造
```json
{
  "accounts": [
    {
      "id": "unique_id",
      "device_name": "Device名",
      "account_name": "アカウント名",
      "issuer": "IssueName",
      "encrypted_secret": "暗号化されたセキュリティコード",
      "created_at": "2024-01-01T00:00:00Z",
      "updated_at": "2024-01-01T00:00:00Z"
    }
  ]
}
```

### 2.3 ワンタイムパスワード表示機能
- **入力**: 登録済みアカウントの選択
- **処理**: pyotpライブラリを使用してOTP生成
- **出力**: 6桁のOTPと残り時間の表示
- **更新**: 1秒間隔での自動更新

#### 2.3.1 表示形式
```
アカウント名: Google Account
OTP: 123456
残り時間: 15秒
```

### 2.4 セキュリティコード管理インターフェース
- **一覧表示**: 登録済みアカウントの一覧
- **更新**: 既存アカウントの情報更新
- **削除**: アカウントの削除
- **追加**: 新しいアカウントの追加

## 3. 非機能要件

### 3.1 セキュリティ要件
- セキュリティコードは暗号化して保存
- ローカルファイルはGitHubにコミットしない（.gitignoreに追加）
- メモリ上のセキュリティコードは使用後即座にクリア
- カメラアクセス権限の適切な管理

### 3.2 パフォーマンス要件
- OTP表示の更新間隔: 1秒
- QRコード解析時間: 5秒以内
- アプリケーション起動時間: 3秒以内
- カメラ映像のフレームレート: 30fps以上

### 3.3 可用性要件
- オフライン動作（インターネット接続不要）
- Dockerコンテナの自動起動・停止
- カメラが利用できない場合の代替手段（画像ファイル読み込み）

### 3.4 互換性要件
- Python 3.8以上
- Docker対応環境
- 主要OS（Windows, macOS, Linux）対応
- 主要カメラデバイス対応

## 4. 技術仕様

### 4.1 使用技術
- **言語**: Python 3.8+
- **ライブラリ**: 
  - pyotp（OTP生成）
  - opencv-python（カメラアクセス・QRコード読み取り）
  - qrcode（QRコード生成）
  - cryptography（暗号化）
  - pyzbar（QRコード解析）
- **外部ツール**: Docker（otpauthコンテナ）

### 4.2 ファイル構成
```
OneTimePassword/
├── src/
│   ├── main.py              # メインアプリケーション
│   ├── camera_qr_reader.py  # カメラQRコード読み取り
│   ├── otp_generator.py     # OTP生成
│   ├── security_manager.py  # セキュリティコード管理
│   ├── crypto_utils.py      # 暗号化ユーティリティ
│   └── docker_manager.py    # Dockerコンテナ管理
├── data/
│   └── accounts.json        # アカウントデータ（暗号化）
├── requirements.txt         # Python依存関係
├── Dockerfile              # Docker設定
├── .gitignore              # Git除外設定
└── README.md               # 使用方法
```

### 4.3 コマンドラインインターフェース
```bash
# カメラでQRコード読み込み
python main.py add --camera

# 画像ファイルからQRコード読み込み
python main.py add --image [画像ファイルパス]

# OTP表示
python main.py show [アカウントID]

# 全アカウントのOTP表示
python main.py show --all

# アカウント一覧
python main.py list

# アカウント削除
python main.py delete [アカウントID]

# アカウント更新
python main.py update [アカウントID] --name [新しい名前]
```

## 5. データフロー

### 5.1 QRコード読み込みフロー（カメラ使用）
1. カメラの初期化とアクセス権限確認
2. リアルタイム映像の取得
3. QRコードの検出と解析
4. URL形式検証
5. DockerコンテナでURL解析
6. セキュリティコード抽出
7. 暗号化してローカル保存
8. カメラリソースの解放

### 5.2 OTP生成フロー
1. アカウント選択
2. セキュリティコード復号化
3. pyotpでOTP生成
4. 残り時間計算
5. 表示・更新

## 6. エラーハンドリング

### 6.1 エラーケース
- カメラアクセス権限なし
- カメラデバイスが見つからない
- QRコード読み取り失敗
- 無効なURL形式
- Dockerコンテナ起動失敗
- セキュリティコード抽出失敗
- ファイルアクセスエラー
- 暗号化/復号化エラー

### 6.2 エラーメッセージ
- ユーザーフレンドリーな日本語メッセージ
- 解決方法の提示
- ログファイルへの詳細記録

## 7. セキュリティ考慮事項

### 7.1 データ保護
- セキュリティコードの暗号化保存
- メモリクリア機能
- ファイル権限設定
- カメラ映像の一時的な保存禁止

### 7.2 アクセス制御
- ローカルファイルの適切な権限設定
- カメラアクセス権限の最小化
- バックアップ時の暗号化

## 8. ユーザーエクスペリエンス

### 8.1 カメラ使用時のUX
- カメラ映像のプレビュー表示
- QRコード検出時の視覚的フィードバック
- 読み取り成功時の確認メッセージ
- カメラの自動停止機能

### 8.2 OTP表示のUX
- リアルタイム更新の視覚的表示
- 残り時間のプログレスバー
- 複数アカウントの同時表示
- コピー機能（クリップボード）

## 9. テスト要件

### 9.1 単体テスト
- カメラアクセス機能
- QRコード解析機能
- OTP生成機能
- 暗号化/復号化機能
- ファイルI/O機能

### 9.2 統合テスト
- エンドツーエンドのカメラQRコード読み込み
- OTP表示の更新機能
- アカウント管理機能
- Dockerコンテナ連携

### 9.3 ハードウェアテスト
- 各種カメラデバイスでの動作確認
- 異なるOS環境での動作確認

## 10. 今後の拡張可能性

### 10.1 機能拡張
- GUI版の開発
- バックアップ・復元機能
- アカウントのインポート・エクスポート
- 複数デバイス間の同期
- 音声読み上げ機能

### 10.2 技術的改善
- パフォーマンス最適化
- エラーハンドリングの強化
- ログ機能の充実
- カメラ映像の最適化

## 11. 開発スケジュール

### 11.1 Phase 1: 基盤開発
- プロジェクト構造の構築
- 基本的なOTP生成機能
- ファイルベースのセキュリティコード管理

### 11.2 Phase 2: カメラ機能
- カメラアクセス機能
- QRコード読み取り機能
- Dockerコンテナ連携

### 11.3 Phase 3: 管理機能
- アカウント管理インターフェース
- エラーハンドリング
- テスト実装

### 11.4 Phase 4: 最適化
- パフォーマンス改善
- UX向上
- ドキュメント整備